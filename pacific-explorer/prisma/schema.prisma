// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
model User {
  id                String         @id @default(cuid())
  name              String?
  email             String         @unique
  emailVerified     DateTime?
  image             String?
  role              Role           @default(TOURIST)
  username          String         @unique
  password          String
  isActive          Boolean        @default(false)
  activationToken   String?        @unique
  activationExpires DateTime?
  stripeCustomerId  String?        @unique // Stripe customer ID for payments
  stripeConnectId   String?        @unique // Stripe Connect account ID for payouts
  stripeConnectStatus String?      // Connect account status (pending, active, etc.)
  stripeConnectChargesEnabled Boolean @default(false)
  stripeConnectPayoutsEnabled Boolean @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  accounts          Account[]
  sessions          Session[]
  hotels            Hotel[] // Hotels owned by this user
  hireCars          HireCar[] // Hire cars owned by this user
  destinations      Destination[] // Destinations owned by this user
  sentMessages      Message[]      @relation("MessageSender") // Messages sent by this user
  receivedMessages  Message[]      @relation("MessageReceiver") // Messages received by this user
  subscriptions     Subscription[] // User subscriptions
  bookings          Booking[]      @relation("BookingTourist") // User bookings as tourist
  hireCarBookings   HireCarBooking[] @relation("HireCarBookingTourist") // User hire car bookings as tourist
  hotelBookings     HotelBooking[] @relation("HotelBookingTourist") // User hotel bookings as tourist
  commissions       Commission[]   @relation("CommissionBusiness") // Commissions earned
  hireCarCommissions HireCarCommission[] @relation("HireCarCommissionBusiness") // Hire car commissions earned
  hotelCommissions  HotelCommission[] @relation("HotelCommissionBusiness") // Hotel commissions earned
  payouts           Payout[]       // Commission payouts received
  ads               Ad[]           @relation("AdAdvertiser") // Ads created by this user
  partnerships      Partnership[]  @relation("PartnershipPartner") // Partnerships
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// User roles
enum Role {
  TOURIST
  HOTEL_OWNER
  HIRE_CAR_OWNER
  DESTINATION_OWNER
  ADMIN
}

// Destination Model
model Destination {
  id                Int           @id @default(autoincrement())
  name              String
  province          String
  category          Category
  description       String        @db.Text
  longDescription   String        @db.Text
  latitude          Float
  longitude         Float
  image             String
  featured          Boolean       @default(false)
  satelliteImageUrl String?
  activities        String[]
  bestTimeToVisit   String
  accessibility     Accessibility
  highlights        String[]
  hotels            Hotel[] // Related hotels at this destination
  bookings          Booking[] // Bookings for this destination
  ownerId           String?
  owner             User?         @relation(fields: [ownerId], references: [id])
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([name, province])
  @@index([category])
  @@index([featured])
}

enum Category {
  Coastal
  Inland
  Geothermal
  Cultural
}

enum Accessibility {
  Easy
  Moderate
  Difficult
}

// Hotel Model
model Hotel {
  id          Int     @id @default(autoincrement())
  name        String
  province    String
  city        String?
  latitude    Float
  longitude   Float
  address     String?
  description String? @db.Text
  website     String?
  phone       String?
  email       String?

  // Hotel Details
  starRating Int? // 1-5 stars
  roomCount  Int?
  priceRange PriceRange?

  // Amenities
  amenities String[] // ["WiFi", "Pool", "Restaurant", "Spa", "Gym", "Bar", "Parking"]

  // From OSM
  osmId     String? @unique
  osmType   String? // hotel, resort, guest_house, motel, hostel
  wikidata  String?
  wikipedia String?

  // Images and Media
  images        String[] // Array of image URLs
  featuredImage String?

  // Status
  verified Boolean @default(false)
  featured Boolean @default(false)
  active   Boolean @default(true)

  // Related destination (if applicable)
  destinationId Int?
  destination   Destination? @relation(fields: [destinationId], references: [id])

  // Owner information
  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id])

  // Bookings
  bookings HotelBooking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([province])
  @@index([featured])
  @@index([active])
  @@index([osmId])
}

enum PriceRange {
  Budget // $ - Under 200 PGK
  Moderate // $$ - 200-500 PGK
  Upscale // $$$ - 500-1000 PGK
  Luxury // $$$$ - Over 1000 PGK
}

// Hire Car Model for vehicle rental services
model HireCar {
  id          Int     @id @default(autoincrement())
  name        String
  province    String
  city        String?
  latitude    Float
  longitude   Float
  address     String?
  description String? @db.Text
  website     String?
  phone       String?
  email       String?

  // Hire Car Details
  vehicleType       String? // SUV, Sedan, Van, Truck, etc.
  passengerCapacity Int?
  pricePerDay       Float?
  priceRange        PriceRange?

  // Features
  features String[] // ["AC", "GPS", "Insurance", "24/7 Support", "Airport Pickup"]

  // Images and Media
  images        String[] // Array of image URLs
  featuredImage String?

  // Status
  verified Boolean @default(false)
  featured Boolean @default(false)
  active   Boolean @default(true)

  // Owner information
  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id])

  // Bookings
  bookings HireCarBooking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([province])
  @@index([featured])
  @@index([active])
}

// Message Model for user-to-user messaging
model Message {
  id         Int       @id @default(autoincrement())
  content    String    @db.Text
  senderId   String
  sender     User      @relation("MessageSender", fields: [senderId], references: [id])
  receiverId String
  receiver   User      @relation("MessageReceiver", fields: [receiverId], references: [id])
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([createdAt])
}

// Subscription Model for premium features
model Subscription {
  id                   Int                @id @default(autoincrement())
  userId               String
  user                 User               @relation(fields: [userId], references: [id])
  plan                 SubscriptionPlan
  status               SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId String?            @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([userId])
  @@index([status])
}

enum SubscriptionPlan {
  BASIC // Free
  PREMIUM // $9.99/month
  PRO // $19.99/month
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

// Commission Model for tracking platform fees
model Commission {
  id               Int              @id @default(autoincrement())
  bookingId        Int              @unique
  booking          Booking          @relation(fields: [bookingId], references: [id])
  amount           Float
  percentage       Float // e.g., 0.10 for 10%
  businessId       String // Business owner who receives the payment
  business         User             @relation("CommissionBusiness", fields: [businessId], references: [id])
  status           CommissionStatus @default(PENDING)
  processedAt      DateTime?
  stripeTransferId String?
  payoutId         Int? // Reference to payout batch
  payout           Payout?         @relation(fields: [payoutId], references: [id])
  createdAt        DateTime         @default(now())

  @@index([businessId])
  @@index([status])
}

enum CommissionStatus {
  PENDING
  PROCESSED
  FAILED
}

// Payout Model for tracking commission payouts to business owners
model Payout {
  id               Int           @id @default(autoincrement())
  businessId       String
  business         User          @relation(fields: [businessId], references: [id])
  amount           Float
  currency         String        @default("USD")
  status           PayoutStatus  @default(PENDING)
  stripePayoutId   String?
  commissions      Commission[]
  hireCarCommissions HireCarCommission[]
  hotelCommissions HotelCommission[]
  processedAt      DateTime?
  failureReason    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([businessId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
}

// Booking Model for tourist reservations
model Booking {
  id              Int           @id @default(autoincrement())
  touristId       String
  tourist         User          @relation("BookingTourist", fields: [touristId], references: [id])
  destinationId   Int
  destination     Destination   @relation(fields: [destinationId], references: [id])
  checkInDate     DateTime
  checkOutDate    DateTime
  totalAmount     Float
  currency        String        @default("USD")
  status          BookingStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  stripePaymentId String?
  commission      Commission?
  confirmedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([touristId])
  @@index([destinationId])
  @@index([status])
}

// Hire Car Booking Model for car rental reservations
model HireCarBooking {
  id               Int              @id @default(autoincrement())
  touristId        String
  tourist          User             @relation("HireCarBookingTourist", fields: [touristId], references: [id])
  hireCarId        Int
  hireCar          HireCar          @relation(fields: [hireCarId], references: [id])
  pickupDate       DateTime
  returnDate       DateTime
  pickupLocation   String
  returnLocation   String
  specialRequests  String?
  totalAmount      Float
  currency         String           @default("USD")
  status           BookingStatus    @default(PENDING)
  paymentStatus    PaymentStatus    @default(PENDING)
  stripePaymentId  String?
  commission       HireCarCommission?
  confirmedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([touristId])
  @@index([hireCarId])
  @@index([status])
}

// Hire Car Commission Model for tracking platform fees on car rentals
model HireCarCommission {
  id               Int              @id @default(autoincrement())
  hireCarBookingId Int              @unique
  hireCarBooking   HireCarBooking   @relation(fields: [hireCarBookingId], references: [id])
  amount           Float
  percentage       Float // e.g., 0.10 for 10%
  businessId       String // Business owner who receives the payment
  business         User             @relation("HireCarCommissionBusiness", fields: [businessId], references: [id])
  status           CommissionStatus @default(PENDING)
  processedAt      DateTime?
  stripeTransferId String?
  payoutId         Int? // Reference to payout batch
  payout           Payout?         @relation(fields: [payoutId], references: [id])
  createdAt        DateTime         @default(now())

  @@index([businessId])
  @@index([status])
}

// Hotel Booking Model for hotel reservations
model HotelBooking {
  id               Int              @id @default(autoincrement())
  touristId        String
  tourist          User             @relation("HotelBookingTourist", fields: [touristId], references: [id])
  hotelId          Int
  hotel            Hotel            @relation(fields: [hotelId], references: [id])
  checkInDate      DateTime
  checkOutDate     DateTime
  guests           Int              @default(1)
  rooms            Int              @default(1)
  specialRequests  String?
  totalAmount      Float
  currency         String           @default("USD")
  status           BookingStatus    @default(PENDING)
  paymentStatus    PaymentStatus    @default(PENDING)
  stripePaymentId  String?
  commission       HotelCommission?
  confirmedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([touristId])
  @@index([hotelId])
  @@index([status])
}

// Hotel Commission Model for tracking platform fees on hotel bookings
model HotelCommission {
  id              Int              @id @default(autoincrement())
  hotelBookingId  Int              @unique
  hotelBooking    HotelBooking     @relation(fields: [hotelBookingId], references: [id])
  amount          Float
  percentage      Float // e.g., 0.10 for 10%
  businessId      String // Business owner who receives the payment
  business        User             @relation("HotelCommissionBusiness", fields: [businessId], references: [id])
  status          CommissionStatus @default(PENDING)
  processedAt     DateTime?
  stripeTransferId String?
  payoutId        Int? // Reference to payout batch
  payout          Payout?         @relation(fields: [payoutId], references: [id])
  createdAt       DateTime         @default(now())

  @@index([businessId])
  @@index([status])
}

enum ServiceType {
  HOTEL
  HIRE_CAR
  DESTINATION
  TOUR
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Ad Model for advertising system
model Ad {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  imageUrl        String?
  targetUrl       String
  advertiserId    String
  advertiser      User      @relation("AdAdvertiser", fields: [advertiserId], references: [id])
  type            AdType
  status          AdStatus  @default(PENDING)
  targetLocations String[] // Province names
  targetInterests String[] // Activity types
  budget          Float // Daily budget
  spent           Float     @default(0)
  impressions     Int       @default(0)
  clicks          Int       @default(0)
  startDate       DateTime
  endDate         DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([advertiserId])
  @@index([status])
  @@index([type])
}

enum AdType {
  BANNER
  SPONSORED_LISTING
  FEATURED_DESTINATION
}

enum AdStatus {
  PENDING
  ACTIVE
  PAUSED
  COMPLETED
  REJECTED
}

// Partnership Model for affiliate relationships
model Partnership {
  id             Int               @id @default(autoincrement())
  partnerId      String
  partner        User              @relation("PartnershipPartner", fields: [partnerId], references: [id])
  name           String // Partner company name
  type           PartnershipType
  commissionRate Float // e.g., 0.05 for 5%
  status         PartnershipStatus @default(ACTIVE)
  contractStart  DateTime
  contractEnd    DateTime?
  contactPerson  String?
  contactEmail   String?
  notes          String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([partnerId])
  @@index([type])
  @@index([status])
}

enum PartnershipType {
  AIRLINE
  INSURANCE
  TOUR_OPERATOR
  HOTEL_CHAIN
  CAR_RENTAL
  GOVERNMENT
}

enum PartnershipStatus {
  ACTIVE
  INACTIVE
  PENDING
  TERMINATED
}
